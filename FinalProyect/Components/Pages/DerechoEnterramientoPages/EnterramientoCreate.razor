@page "/enterramiento/create"
@rendermode InteractiveServer

@using FinalProyect.Models
@using Microsoft.AspNetCore.Identity
@using FinalProyect.Data
@using FinalProyect.Services

@inject DerechoEnterramientoService EnterramientoService
@inject SolicitanteService SolicitanteService
@inject DocumentoService DocumentoService
@inject NavigationManager Nav
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3 class="mb-4 text-primary fw-bold">Registrar Derecho a Enterramiento</h3>

<div class="card shadow-sm p-4 mt-3">

    <EditForm FormName="EnterramientoForm" Model="@Modelo" OnValidSubmit="Guardar">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- DATOS DEL SOLICITANTE -->
        <h5 class="text-primary mb-3">Datos del Solicitante</h5>

        <div class="mb-3">
            <label class="form-label fw-semibold">Cédula</label>
            <InputText class="form-control" @bind-Value="SolicitanteProceso.Cedula" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Nombre Completo</label>
            <InputText class="form-control" @bind-Value="SolicitanteProceso.NombreCompleto" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Teléfono</label>
            <InputText class="form-control" @bind-Value="SolicitanteProceso.Telefono" />
        </div>

        <hr />

        <!-- SUBIDA DE DOCUMENTOS -->
        <h5 class="text-primary mb-3">Documentos del Solicitante</h5>

        <div class="mb-3">
            <label class="form-label fw-semibold">Cédula del solicitante *</label>
            <InputFile OnChange="OnCedulaSolicitanteSelected" class="form-control" />
        </div>

        <hr />

        <!-- DATOS DEL FALLECIDO -->
        <h5 class="text-primary mb-3">Datos del Fallecido</h5>

        <div class="mb-3">
            <label class="form-label fw-semibold">Nombre del fallecido</label>
            <InputText class="form-control" @bind-Value="Modelo.NombreFallecido" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Cédula del fallecido *</label>
            <InputFile OnChange="OnCedulaFallecidoSelected" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Número de Cédula del fallecido</label>
            <InputText class="form-control" @bind-Value="Modelo.CedulaFallecido" />
        </div>

        <!-- ACTA DE DEFUNCIÓN -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Acta de defunción o certificación *</label>
            <InputFile OnChange="OnActaDefuncionSelected" class="form-control" />
        </div>

        <hr />

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Fecha</label>
                <InputDate class="form-control" @bind-Value="Modelo.Fecha" />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Hora</label>
                <InputText class="form-control" @bind-Value="HoraTexto" placeholder="HH:mm" />
            </div>
        </div>

        <button type="submit" class="btn btn-success mt-3">
            <i class="fas fa-save"></i> Guardar y generar recibo
        </button>

    </EditForm>

</div>

@code {
    private DerechoEnterramiento Modelo { get; set; } = new();
    private Solicitante SolicitanteProceso { get; set; } = new();

    private IBrowserFile? CedulaSolicitanteFile;
    private IBrowserFile? CedulaFallecidoFile;
    private IBrowserFile? ActaDefuncionFile;

    private string HoraTexto { get; set; } = "";

    private void OnCedulaSolicitanteSelected(InputFileChangeEventArgs e)
        => CedulaSolicitanteFile = e.File;

    private void OnCedulaFallecidoSelected(InputFileChangeEventArgs e)
        => CedulaFallecidoFile = e.File;

    private void OnActaDefuncionSelected(InputFileChangeEventArgs e)
        => ActaDefuncionFile = e.File;

    private async Task<string> GetUserId()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        return authState.User.Identity?.IsAuthenticated == true
            ? UserManager.GetUserId(authState.User)
            : "";
    }

    private async Task Guardar()
    {
        Modelo.UsuarioId = await GetUserId();

        if (SolicitanteProceso.Id == 0)
            await SolicitanteService.Crear(SolicitanteProceso);

        Modelo.SolicitanteId = SolicitanteProceso.Id;

        if (!string.IsNullOrWhiteSpace(HoraTexto))
            Modelo.Hora = TimeSpan.Parse(HoraTexto);

        int id = await EnterramientoService.Crear(Modelo);

        if (CedulaSolicitanteFile != null)
        {
            using var st = CedulaSolicitanteFile.OpenReadStream();
            await DocumentoService.SubirDocumentoAsync(st, CedulaSolicitanteFile.Name, DocumentType.CedulaSolicitante, enterramientoId: id);
        }

        if (CedulaFallecidoFile != null)
        {
            using var st = CedulaFallecidoFile.OpenReadStream();
            await DocumentoService.SubirDocumentoAsync(st, CedulaFallecidoFile.Name, DocumentType.CedulaFallecido, enterramientoId: id);
        }

        if (ActaDefuncionFile != null)
        {
            using var st = ActaDefuncionFile.OpenReadStream();
            await DocumentoService.SubirDocumentoAsync(st, ActaDefuncionFile.Name, DocumentType.ActaDefuncion, enterramientoId: id);
        }

        Nav.NavigateTo($"/recibo/create/{id}?proceso=enterramiento");
    }
}
